/**
 * @file Firestore Security Rules for CoLiveAssist.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data and a shared-access model for roommate groups, bills, and chores.
 * Authorization is primarily based on verified user identity and explicit group membership.  Schema validation is relaxed in this prototyping phase.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /users/{userId}/roommatePreferences/{roommatePreferenceId}: Roommate preferences, accessible only by the user.
 * - /users/{userId}/roomPreferences/{roomPreferenceId}: Room preferences, accessible only by the user.
 * - /roommateGroups/{roommateGroupId}: Roommate groups, accessible only by group members.
 * - /roommateGroups/{roommateGroupId}/bills/{billId}: Bills associated with roommate groups, accessible only by group members.
 * - /roommateGroups/{roommateGroupId}/chores/{choreId}: Chores assigned within roommate groups, accessible only by group members and assigned user.
 * - /roommateGroups/{roommateGroupId}/complaints/{complaintId}: Complaints submitted by users, accessible only by group members.
 * - /feedback/{feedbackId}: Feedback submitted by users, accessible only by the user themselves.
 *
 * Key Security Decisions:
 * - User data is strictly private. Users can only access their own profiles and preferences.
 * - Roommate groups, bills, and chores are accessible to all members of the group, enforced via a `members` map on the `roommateGroups` document.
 * - List operations are secured to prevent unauthorized data access.
 *
 * Denormalization for Authorization:
 * - The `roommateGroups` documents contain a `members` map that explicitly lists the UIDs of all group members and their roles.
 * - The `bills`, `chores`, and `complaints` documents are subcollections of `roommateGroups` and inherit authorization from the `members` map of their parent.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents. Only the authenticated user can read and write their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user_abc' can create their profile: request.auth.uid == 'user_abc' and request.resource.data.id == 'user_abc'.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write their profile: request.auth.uid == 'user_abc' and resource.data.id == 'user_abc'.
     * @deny (create) User with ID 'user_xyz' cannot create profile for 'user_abc': request.auth.uid == 'user_xyz' and request.resource.data.id == 'user_abc'.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify profile for 'user_abc': request.auth.uid == 'user_xyz' and resource.data.id == 'user_abc'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user roommate preferences. Only the authenticated user can read and write their own preferences.
     * @path /users/{userId}/roommatePreferences/{roommatePreferenceId}
     * @allow (create) User with ID 'user_abc' can create their roommate preference: request.auth.uid == 'user_abc'.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write their roommate preference: request.auth.uid == 'user_abc'.
     * @deny (create) User with ID 'user_xyz' cannot create roommate preference for 'user_abc': request.auth.uid == 'user_xyz'.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify roommate preference for 'user_abc': request.auth.uid == 'user_xyz'.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/roommatePreferences/{roommatePreferenceId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user room preferences. Only the authenticated user can read and write their own preferences.
     * @path /users/{userId}/roomPreferences/{roomPreferenceId}
     * @allow (create) User with ID 'user_abc' can create their room preference: request.auth.uid == 'user_abc'.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write their room preference: request.auth.uid == 'user_abc'.
     * @deny (create) User with ID 'user_xyz' cannot create room preference for 'user_abc': request.auth.uid == 'user_xyz'.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify room preference for 'user_abc': request.auth.uid == 'user_xyz'.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/roomPreferences/{roomPreferenceId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to roommate group documents. Only members of the group can read and write.
     * @path /roommateGroups/{roommateGroupId}
     * @allow (create) User with ID 'user_abc' can create a roommate group if request.auth.uid is in request.resource.data.members.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write roommate group if request.auth.uid is in resource.data.members.
     * @deny (create) User with ID 'user_xyz' cannot create a roommate group if request.auth.uid is not in request.resource.data.members.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify roommate group if request.auth.uid is not in resource.data.members.
     * @principle Enforces shared access based on group membership.
     */
    match /roommateGroups/{roommateGroupId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && request.auth.uid in resource.data.members;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.members;
      allow update: if isSignedIn() && request.auth.uid in resource.data.members && resource != null;
      allow delete: if isSignedIn() && request.auth.uid in resource.data.members && resource != null;
    }

    /**
     * @description Controls access to bills associated with a roommate group. Only members of the group can read and write.
     * @path /roommateGroups/{roommateGroupId}/bills/{billId}
     * @allow (create) User with ID 'user_abc' can create a bill if request.auth.uid is in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write bill if request.auth.uid is in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @deny (create) User with ID 'user_xyz' cannot create a bill if request.auth.uid is not in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify bill if request.auth.uid is not in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @principle Enforces shared access based on group membership.
     */
    match /roommateGroups/{roommateGroupId}/bills/{billId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMember() {
        return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members;
      }
       allow get: if isMember();
       allow list: if isMember();
       allow create: if isMember();
       allow update: if isMember() && resource != null;
       allow delete: if isMember() && resource != null;
    }

    /**
     * @description Controls access to chores assigned within a roommate group. Only members of the group and the assigned user can access the chores.
     * @path /roommateGroups/{roommateGroupId}/chores/{choreId}
     * @allow (create) User with ID 'user_abc' can create a chore if request.auth.uid is in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write chore if request.auth.uid is in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members or assigned to them.
     * @deny (create) User with ID 'user_xyz' cannot create a chore if request.auth.uid is not in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify chore if request.auth.uid is not in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members and is not the assigned user.
     * @principle Enforces shared access based on group membership and assignment.
     */
    match /roommateGroups/{roommateGroupId}/chores/{choreId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMember() {
        return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members;
      }
      function isAssignedToUser() {
          return isSignedIn() && request.auth.uid == resource.data.assignedToUserId;
      }
       allow get: if isMember() || isAssignedToUser();
       allow list: if isMember();
       allow create: if isMember();
       allow update: if isMember() && resource != null;
       allow delete: if isMember() && resource != null;
    }

    /**
     * @description Controls access to user complaints within a roommate group. Only group members can read and write.
     * @path /roommateGroups/{roommateGroupId}/complaints/{complaintId}
     * @allow (create) A group member can create a complaint.
     * @allow (get, list) Group members can view all complaints.
     * @deny (all) Non-group members cannot access complaints.
     * @principle Enforces shared access for group-related issues.
     */
    match /roommateGroups/{roommateGroupId}/complaints/{complaintId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isMember() {
        return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/roommateGroups/$(roommateGroupId)).data.members;
      }
      allow get: if isMember();
      allow list: if isMember();
      allow create: if isMember() && request.auth.uid == request.resource.data.userId;
      allow update: if isMember() && resource != null;
      allow delete: if isMember() && resource != null;
    }

    /**
     * @description Controls access to user feedback. Only the authenticated user can read and write their own feedback.
     * @path /feedback/{feedbackId}
     * @allow (create) User with ID 'user_abc' can create their feedback.
     * @allow (get, update, delete) User with ID 'user_abc' can read/write their feedback.
     * @deny (create) User with ID 'user_xyz' cannot create feedback for 'user_abc'.
     * @deny (update, delete) User with ID 'user_xyz' cannot modify feedback for 'user_abc'.
     * @principle Restricts access to a user's own data tree.
     */
    match /feedback/{feedbackId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow list: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId && resource != null;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId && resource != null;
    }
  }
}
